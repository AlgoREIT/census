{% extends 'base.html' %}
{% load helpertags %}
{% load humanize %}

{% block content %}
<script type="text/javascript" src="{{ MEDIA_URL }}js/browser.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.scrollfollow.js"></script>

<span class="button" id="show-browser">show the thing</span>

<script id="browser-template" type="x-js-template">
    <div id="floater">
        <h1>Hello!</h1>
        <ul id="table-list" class="cookie1">
        <% $('table.report').each(function(index, report) { x = $(report); %>
            <li>
                <input
                    type="checkbox"
                    id="show-<%= $(report).attr('id') %>"
                    name="show-<%= $(report).attr('id') %>"
                    <% if ($(report).is(':visible')) { %>checked="checked"<% } %>>
                <label for="show-<%= $(report).attr('id') %>">
                    <a href="#<%= $(report).attr('id') %>" class="link"><%= $(report).attr('data-val') %></a>
                </label>
            </li>
        <% }); %>
        </ul>
    </div>
</script>

<script id="report-template" type="x-js-template">
    <a name="report-<%= key %>"></a>
    <table class="report" id="report-<%= key %>" data-val="<%= name %>">
        <colgroup></colgroup><colgroup></colgroup>
        <% _.each(columns, function(c) { %>
        <colgroup></colgroup><colgroup></colgroup><colgroup></colgroup><colgroup></colgroup>
        <% }); %>
        <tr>
            <th rowspan="2" class="labeldef"><%= table %><br /><span class="universe">Universe: <%= universe %></span></th>
            <% _.each(columns, function(c) { %>
            <th colspan="4" class="locationdef">
                <%= c.name %>
                <div class="button-set">
                <% if ($.inArray(c.sumlev, ["050", "160", "140", "101"])) { %>
                    <% if ($.inArray(c.geoid.substr(0, 2), geoid_list) === -1) { %>
                    <span class="button add-related-state" title="Show state that contains this" data-val="<%= c.geoid %>">Add state &raquo;</span>
                    <% } %>
                <% } %>
                <% if ($.inArray(c.sumlev, ["140", "101"])) { %>
                    <% if ($.inArray(c.geoid.substr(0, 5), geoid_list) === -1) { %>
                    <span class="button add-related-county" title="Show county that contains this" data-val="<%= c.geoid %>">Add county &raquo;</span>
                    <% } %>
                <% } %>
                <% if (show_remove_button === true) { %>
                    <span class="button remove-column" data-val="<%= c.geoid %>">Remove</span>
                <% } %>
                </div>
            </th>
            <% }); %>
        </tr>
        <tr>
            <% _.each(columns, function(c) { %>
            <th class="subhead">2000</th>
            <th class="subhead">2010</th>
            <th class="subhead">Delta</th>
            <th class="subhead">% change</th>
            <% }); %>
        </tr>
        <% _.each(rows, function(row) { %>
        <tr
            id="<%= row.key %>" parent="{{ row.label.parent }}"
            style="<% if (row.label.indent > 2) { %>display:none;<% } %>"
        >
           <td class="label"><%= row.label.text %> <span class="key"><%= row.key %></span></td>
            <% _.each(row.data, function(d) { %>
            <!-- TODO: int and float format --> 
            <td class="code data-cell"><%= d["2000"] %></td>
            <td class="code data-cell"><%= d["2010"] %></td>
            <td class="code data-cell"><%= d["delta"] %></td>
            <td class="code data-cell <% if (false) { %>last<% } %>"><%= d.pct_change %></td>
            <% }); %>
        </tr>
        <% }); %>
    </table>
</script>

<nav>
    <span class="button more-data">Add another geography to compare</span>
    &nbsp;or download as
    <a class="button" href="TODO">CSV</a>
    <a class="button" href="TODO">JSON</a>
    <a class="button" href="TODO">KML</a>
</nav>

<section id="table-container">
</section>

<div class="query-builder-popup hidden">
    {% include "_query_builder.html" %}
</div>

<script type="text/javascript">
    $(function(){
        $('.button.more-data').click(function(){
            $('.query-builder-popup').dialog({
                draggable:false,
                resizable:false,
                modal:true,
                height:600,
                minWidth:800
            });
            // TODO
            //query.initializeWithGeography({{ last_geoid }});
        });
    });
</script>

<script type="text/javascript">
    // Testing loading of labels and data from S3
    $(function(){
        var dataset = "SF1";

        $.ajax("http://s3.amazonaws.com/census-test/" + dataset + "_labels.jsonp", {
            dataType: "jsonp",
            jsonpCallback: "labels_" + dataset,
            success: function(labels_data) {
                // TODO
                var geoid = "10";

                var tables = _.keys(labels_data["tables"]);
                tables.sort();

                $.ajax("http://s3.amazonaws.com/census-test/" + geoid + ".jsonp", {
                    dataType: "jsonp",
                    jsonpCallback: "geoid_" + geoid,
                    success: function(geography_data) {
                        // TODO - temp, replace with tables var
                        _.each(["P1"], function(table_name) {
                            table = labels_data["tables"][table_name];

                            report = {
                                'key': table["key"],
                                'name': table['name'],
                                'table': table["key"] + ". " + table['name'],
                                'universe': table['universe'],
                                'columns': [],
                                'rows': []
                            };

                            labels = table["labels"];

                            _.each(labels, function(label) {
                                row = {
                                    "key": label["key"],
                                    "label": label,
                                    "data": []
                                }

                                data = [];
    
                                // TODO - iterate over geographies
                                
                                d = {};
                                _.each(['2000','2010','delta','pct_change'], function(year) {
                                    try {
                                        d[year] = geography_data["data"][year][table_name][label["key"]];
                                    } catch(err) {
                                    }
                                });

                                row["data"].push(d);


                                report["rows"].push(row);
                            });

                            column_meta = {};
                            column_name = geography_data["metadata"]["NAME"];

                            // TODO
                            if ($.inArray(geography_data["sumlev"], [SUMLEV_COUNTY, SUMLEV_PLACE, SUMLEV_TRACT])) {
                                column_name += ", TODO"; 
                            }

                            column_meta["name"] = column_name;
                            column_meta["geoid"] = geography_data["geoid"];
                            column_meta["sumlev"] = geography_data["sumlev"];

                            report["columns"].push(column_meta);

                            // TODO
                            report["geoid_list"] = ["10"];
                            report["show_remove_button"] = true;

                            console.log(report);

                            var template = template = _.template($('#report-template').html());
                            var html = template(report);

                            $('#table-container').before(html)
                        });
                

                    }
                });
            }
        });
    });
</script>

<div id="status" style="display:none;"></div>

{% endblock %}
